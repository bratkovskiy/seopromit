{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Создание нового проекта</h1>
        
        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <form method="POST" action="" id="projectForm">
                    {{ form.hidden_tag() }}
                    {{ form.metrika_validated(id="metrika_validated") }}
                    {{ form.webmaster_validated(id="webmaster_validated") }}
                    
                    <div class="space-y-6">
                        <div>
                            {{ form.name.label(class="block text-sm font-medium text-gray-700") }}
                            {{ form.name(class="mt-1 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md") }}
                            {% for error in form.name.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="bg-gray-50 px-4 py-5 sm:rounded-lg sm:p-6">
                            <div class="md:grid md:grid-cols-3 md:gap-6">
                                <div class="md:col-span-1">
                                    <h3 class="text-lg font-medium leading-6 text-gray-900">Яндекс.Метрика</h3>
                                    <p class="mt-1 text-sm text-gray-500">
                                        Настройте интеграцию с Яндекс.Метрикой
                                    </p>
                                </div>
                                <div class="mt-5 md:mt-0 md:col-span-2">
                                    <div class="grid grid-cols-6 gap-6">
                                        <div class="col-span-6">
                                            {{ form.yandex_metrika_counter.label(class="block text-sm font-medium text-gray-700") }}
                                            {{ form.yandex_metrika_counter(class="mt-1 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md") }}
                                            {% for error in form.yandex_metrika_counter.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                        <div class="col-span-6">
                                            {{ form.yandex_metrika_token.label(class="block text-sm font-medium text-gray-700") }}
                                            {{ form.yandex_metrika_token(class="mt-1 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md") }}
                                            {% for error in form.yandex_metrika_token.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                        <div class="col-span-6">
                                            {{ form.validate_metrika(class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500") }}
                                            <span id="metrika_status" class="ml-2 text-sm"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 px-4 py-5 sm:rounded-lg sm:p-6">
                            <div class="md:grid md:grid-cols-3 md:gap-6">
                                <div class="md:col-span-1">
                                    <h3 class="text-lg font-medium leading-6 text-gray-900">Яндекс.Вебмастер</h3>
                                    <p class="mt-1 text-sm text-gray-500">
                                        Настройте интеграцию с Яндекс.Вебмастером
                                    </p>
                                </div>
                                <div class="mt-5 md:mt-0 md:col-span-2">
                                    <div class="grid grid-cols-6 gap-6">
                                        <div class="col-span-6">
                                            {{ form.yandex_webmaster_host.label(class="block text-sm font-medium text-gray-700") }}
                                            {{ form.yandex_webmaster_host(class="mt-1 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md") }}
                                            {% for error in form.yandex_webmaster_host.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                        <div class="col-span-6">
                                            {{ form.yandex_webmaster_token.label(class="block text-sm font-medium text-gray-700") }}
                                            {{ form.yandex_webmaster_token(class="mt-1 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md") }}
                                            {% for error in form.yandex_webmaster_token.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                        <div class="col-span-6">
                                            {{ form.yandex_webmaster_user_id.label(class="block text-sm font-medium text-gray-700") }}
                                            {{ form.yandex_webmaster_user_id(class="mt-1 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md") }}
                                            {% for error in form.yandex_webmaster_user_id.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                        <div class="col-span-6 flex items-center justify-end">
                                            {{ form.validate_webmaster(class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500") }}
                                            <span id="webmaster_status" class="ml-2 text-sm"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <a href="{{ url_for('main.dashboard') }}"
                           class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Отмена
                        </a>
                        {{ form.submit(id="submit_button", class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50", disabled=True) }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('projectForm');
    const submitBtn = document.getElementById('submit_button');
    const metrikaValidated = document.getElementById('metrika_validated');
    const webmasterValidated = document.getElementById('webmaster_validated');
    const metrikaStatus = document.getElementById('metrika_status');
    const webmasterStatus = document.getElementById('webmaster_status');

    function checkSubmitAvailability() {
        console.log('Checking submit availability:', {
            metrikaValidated: metrikaValidated?.value,
            webmasterValidated: webmasterValidated?.value,
            submitBtn: submitBtn ? 'exists' : 'not found'
        });
        
        if (submitBtn && metrikaValidated && webmasterValidated) {
            submitBtn.disabled = !(metrikaValidated.value === 'true' && webmasterValidated.value === 'true');
        }
    }

    // Получаем CSRF-токен из мета-тега
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    function checkSubmitAvailability() {
        console.log('Checking submit availability:', {
            metrikaValidated: metrikaValidated?.value,
            webmasterValidated: webmasterValidated?.value,
            submitBtn: submitBtn ? 'exists' : 'not found'
        });
        
        if (submitBtn && metrikaValidated && webmasterValidated) {
            submitBtn.disabled = !(metrikaValidated.value === 'true' && webmasterValidated.value === 'true');
        }
    }

    // Обработчик для валидации Метрики
    const validateMetrikaBtn = form.querySelector('input[value="Проверить Яндекс.Метрику"]');
    if (validateMetrikaBtn) {
        validateMetrikaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const counter = document.getElementById('yandex_metrika_counter').value;
            const token = document.getElementById('yandex_metrika_token').value;

            console.log('Валидация Метрики:', { counter, token: token.substring(0, 10) + '...' });

            if (!counter || !token) {
                metrikaStatus.textContent = '✗ Заполните все поля';
                metrikaStatus.className = 'ml-2 text-sm text-red-600';
                metrikaValidated.value = 'false';
                checkSubmitAvailability();
                return;
            }

            metrikaStatus.textContent = '⌛ Проверяем подключение...';
            metrikaStatus.className = 'ml-2 text-sm text-gray-600';

            fetch('/validate_metrika', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    counter: counter,
                    token: token
                })
            })
            .then(response => {
                console.log('Ответ сервера (статус):', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Ответ сервера (данные):', data);
                if (data.success) {
                    metrikaStatus.textContent = '✓ ' + data.message;
                    metrikaStatus.className = 'ml-2 text-sm text-green-600';
                    metrikaValidated.value = 'true';
                } else {
                    metrikaStatus.textContent = '✗ ' + data.message;
                    metrikaStatus.className = 'ml-2 text-sm text-red-600';
                    metrikaValidated.value = 'false';
                }
                checkSubmitAvailability();
            })
            .catch(error => {
                console.error('Ошибка при валидации Метрики:', error);
                metrikaStatus.textContent = '✗ Ошибка при проверке подключения';
                metrikaStatus.className = 'ml-2 text-sm text-red-600';
                metrikaValidated.value = 'false';
                checkSubmitAvailability();
            });
        });
    }

    // Обработчик для валидации Вебмастера
    const validateWebmasterBtn = form.querySelector('input[value="Проверить Яндекс.Вебмастер"]');
    if (validateWebmasterBtn) {
        validateWebmasterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const host = document.getElementById('yandex_webmaster_host').value;
            const token = document.getElementById('yandex_webmaster_token').value;
            const user_id = document.getElementById('yandex_webmaster_user_id').value;

            console.log('Валидация Вебмастера:', { 
                host, 
                token: token.substring(0, 10) + '...', 
                user_id 
            });

            if (!host || !token || !user_id) {
                webmasterStatus.textContent = '✗ Заполните все поля';
                webmasterStatus.className = 'ml-2 text-sm text-red-600';
                webmasterValidated.value = 'false';
                checkSubmitAvailability();
                return;
            }

            webmasterStatus.textContent = '⌛ Проверяем подключение...';
            webmasterStatus.className = 'ml-2 text-sm text-gray-600';

            fetch('/validate_webmaster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    host: host,
                    token: token,
                    user_id: user_id
                })
            })
            .then(response => {
                console.log('Ответ сервера (статус):', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Ответ сервера (данные):', data);
                if (data.success) {
                    webmasterStatus.textContent = '✓ ' + data.message;
                    webmasterStatus.className = 'ml-2 text-sm text-green-600';
                    document.getElementById('webmaster_validated').value = 'true';
                } else {
                    webmasterStatus.textContent = '✗ ' + data.message;
                    webmasterStatus.className = 'ml-2 text-sm text-red-600';
                    document.getElementById('webmaster_validated').value = 'false';
                }
                checkSubmitAvailability();
            })
            .catch(error => {
                console.error('Ошибка при валидации Вебмастера:', error);
                webmasterStatus.textContent = '✗ Ошибка при проверке подключения';
                webmasterStatus.className = 'ml-2 text-sm text-red-600';
                document.getElementById('webmaster_validated').value = 'false';
                checkSubmitAvailability();
            });
        });
    }

    // Сброс валидации при изменении полей
    ['yandex_metrika_counter', 'yandex_metrika_token'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', function() {
                metrikaValidated.value = 'false';
                metrikaStatus.textContent = '';
                checkSubmitAvailability();
            });
        }
    });

    ['yandex_webmaster_host', 'yandex_webmaster_token', 'yandex_webmaster_user_id'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', function() {
                webmasterValidated.value = 'false';
                webmasterStatus.textContent = '';
                checkSubmitAvailability();
            });
        }
    });
});
</script>
{% endblock %}
